import pdfplumber
from typing import Dict


class GSTPaymentParser:

    TARGET_ROWS = ["Integrated tax", "Central tax", "State/UT tax", "Cess"]

    def __init__(self, pdf_path: str):
        self.pdf_path = pdf_path

    def _find_section_a_table(self):
        with pdfplumber.open(self.pdf_path) as pdf:
            if len(pdf.pages) < 2:
                raise ValueError("PDF does not contain Page 2.")

            page = pdf.pages[1]

            # Extract all tables using line detection
            tables = page.extract_tables()

            if not tables:
                raise ValueError("No tables detected on page 2.")

            # Find table containing Section A
            for table in tables:
                for row in table:
                    if row and any("Other than reverse charge" in str(cell) for cell in row if cell):
                        return table

            raise ValueError("Section (A) table not found.")

    def parse(self) -> Dict[str, float]:

        table = self._find_section_a_table()

        result = {}
        in_section_a = False

        for row in table:
            if not row:
                continue

            first_cell = str(row[0]).strip() if row[0] else ""

            if "Other than reverse charge" in first_cell:
                in_section_a = True
                continue

            if "Reverse charge" in first_cell:
                break

            if not in_section_a:
                continue

            if first_cell in self.TARGET_ROWS:

                cleaned = []
                for cell in row:
                    if cell is None or cell.strip() in ["", "-"]:
                        cleaned.append("0")
                    else:
                        cleaned.append(cell.replace(",", "").strip())

                try:
                    itc_integrated = float(cleaned[4])
                    itc_central = float(cleaned[5])
                    itc_state = float(cleaned[6])
                    itc_cess = float(cleaned[7])
                except (IndexError, ValueError):
                    itc_integrated = itc_central = itc_state = itc_cess = 0.0

                itc_values = [
                    itc_integrated,
                    itc_central,
                    itc_state,
                    itc_cess
                ]

                own_index = {
                    "Integrated tax": 0,
                    "Central tax": 1,
                    "State/UT tax": 2,
                    "Cess": 3
                }[first_cell]

                # Cross-utilisation logic
                if itc_values[own_index] != 0:
                    result[first_cell] = 0.0
                else:
                    cross_value = 0.0
                    for idx, val in enumerate(itc_values):
                        if idx != own_index and val != 0:
                            cross_value = val
                            break
                    result[first_cell] = cross_value

        for tax in self.TARGET_ROWS:
            if tax not in result:
                result[tax] = 0.0

        return result


# ---------------- RUN ----------------
if __name__ == "__main__":
    pdf_file = r"yourfile.pdf"

    parser = GSTPaymentParser(pdf_file)

    try:
        output = parser.parse()
        print("\nFinal Cross-Utilised ITC Values (Section A Only):")
        print(output)
    except Exception as e:
        print("Error:", e)
