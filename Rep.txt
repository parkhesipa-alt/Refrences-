from pydantic import BaseModel, validator, Field
from typing import List
import re

PAN_REGEX = r'^[A-Z]{5}\d{4}[A-Z]{1}$'


class BulkPANRequest(BaseModel):
    username: str = Field(..., min_length=3, max_length=50)
    password: str = Field(..., min_length=3)
    panList: List[str] = Field(..., min_items=1, max_items=50)

    @validator("panList", each_item=True)
    def validate_pan(cls, v: str):
        if not re.match(PAN_REGEX, v):
            raise ValueError(f"Invalid PAN format: {v}")
        return v.upper()




@router.post("/bulk_pan")
async def bulk_pan_verification(req: BulkPANRequest):

    # -------- AUTH VALIDATION --------
    project_id = os.getenv("GCP_PROJECT_ID")
    if not project_id:
        raise HTTPException(status_code=500, detail="Project ID not configured")

    try:
        secret_name = f"USER_{req.username}"
        stored_password = get_secret_from_gcp(secret_name, project_id)
    except Exception:
        raise HTTPException(status_code=401, detail="Invalid credentials")

    if req.password != stored_password:
        raise HTTPException(status_code=401, detail="Invalid credentials")

    # -------- EXISTING LOGIC --------
    if not req.panList:
        raise HTTPException(status_code=400, detail="panList cannot be empty")

    if len(req.panList) > 50:
        raise HTTPException(status_code=400, detail="Max 50 PANs allowed per request")

    tasks = [process_single_pan(pan) for pan in req.panList]
    results = await asyncio.gather(*tasks)

    return {
        "total": len(results),
        "results": results
    }

