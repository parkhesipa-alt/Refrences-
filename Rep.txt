import pdfplumber
from collections import defaultdict
from typing import Dict


class GSTPaymentParser:

    def __init__(self, pdf_path: str):
        self.pdf_path = pdf_path

    def parse(self) -> Dict[str, float]:

        with pdfplumber.open(self.pdf_path) as pdf:
            page = pdf.pages[1]  # Page 2

            words = page.extract_words(
                use_text_flow=True,
                keep_blank_chars=False
            )

        # Group words by vertical position (row detection)
        rows = defaultdict(list)

        for w in words:
            # round Y position to group row text
            row_key = round(w["top"], 0)
            rows[row_key].append(w)

        parsed_rows = []

        for row in rows.values():
            # sort left to right
            row_sorted = sorted(row, key=lambda x: x["x0"])
            row_text = " ".join([w["text"] for w in row_sorted])
            parsed_rows.append(row_text)

        # Filter only Section (A)
        section_a_rows = []
        capture = False

        for line in parsed_rows:
            if "(A)" in line and "Other than reverse charge" in line:
                capture = True
                continue

            if "(B)" in line:
                break

            if capture:
                section_a_rows.append(line)

        result = {}

        for line in section_a_rows:

            if line.startswith("Integrated"):
                tax_type = "Integrated tax"
            elif line.startswith("Central"):
                tax_type = "Central tax"
            elif line.startswith("State/UT"):
                tax_type = "State/UT tax"
            elif line.startswith("Cess"):
                tax_type = "Cess"
            else:
                continue

            parts = line.split()

            # Extract numeric values only
            numbers = [p for p in parts if any(c.isdigit() for c in p)]

            # Ensure enough columns
            while len(numbers) < 7:
                numbers.append("0")

            itc_integrated = float(numbers[3])
            itc_central = float(numbers[4])
            itc_state = float(numbers[5])
            itc_cess = float(numbers[6])

            itc_values = [
                itc_integrated,
                itc_central,
                itc_state,
                itc_cess
            ]

            own_index = {
                "Integrated tax": 0,
                "Central tax": 1,
                "State/UT tax": 2,
                "Cess": 3
            }[tax_type]

            # CROSS UTILISATION LOGIC
            if itc_values[own_index] != 0:
                result[tax_type] = 0.0
            else:
                cross_val = 0.0
                for i, val in enumerate(itc_values):
                    if i != own_index and val != 0:
                        cross_val = val
                        break
                result[tax_type] = cross_val

        # Ensure all tax types present
        for tax in ["Integrated tax", "Central tax", "State/UT tax", "Cess"]:
            if tax not in result:
                result[tax] = 0.0

        return result


# ---------------- RUN ----------------

if __name__ == "__main__":
    pdf_file = r"yourfile.pdf"

    parser = GSTPaymentParser(pdf_file)
    output = parser.parse()

    print("\nFinal Cross-Utilised ITC Values (Section A Only):")
    print(output)
